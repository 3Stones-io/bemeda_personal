# Optimum Codegen
# Usage: make [command]

new:
	@if [ -z "$(filter-out $@,$(MAKECMDGOALS))" ]; then \
		echo "Usage: make new <feature-name>"; \
		echo "Example: make new dashboard-redesign"; \
		exit 1; \
	fi
	@./create_workspace.sh $(filter-out $@,$(MAKECMDGOALS))

rm:
	@if [ -z "$(filter-out $@,$(MAKECMDGOALS))" ]; then \
		echo "Usage: make rm <feature-name>"; \
		echo "Example: make rm dashboard-redesign"; \
		exit 1; \
	fi
	@./remove_workspace.sh $(filter-out $@,$(MAKECMDGOALS))

resume:
	@if [ -z "$(filter-out $@,$(MAKECMDGOALS))" ]; then \
		echo "Usage: make resume <feature-name>"; \
		echo "Example: make resume dashboard-redesign"; \
		exit 1; \
	fi
	@./resume_workspace.sh $(filter-out $@,$(MAKECMDGOALS))

ls:
	@./list_workspaces.sh

playwright:
	@echo "ğŸ­ Starting Playwright MCP server..."
	@if lsof -i :8931 >/dev/null 2>&1; then \
		echo "   âœ… Playwright MCP server is already running on port 8931"; \
	else \
		npx @playwright/mcp@latest --port 8931 >/dev/null 2>&1 & \
		echo "   ğŸš€ Playwright MCP server started in background"; \
		echo "   â³ Waiting for server to be ready..."; \
		max_attempts=30; \
		attempt=0; \
		while [ $$attempt -lt $$max_attempts ]; do \
			if lsof -i :8931 >/dev/null 2>&1; then \
				echo "   âœ… Playwright MCP server is ready on port 8931"; \
				echo "   ğŸ“Š Process ID: $$(lsof -ti tcp:8931 | head -1)"; \
				break; \
			fi; \
			sleep 1; \
			attempt=$$((attempt + 1)); \
		done; \
		if [ $$attempt -eq $$max_attempts ]; then \
			echo "   âŒ Failed to start Playwright MCP server within 30 seconds"; \
			exit 1; \
		fi; \
	fi

kill-playwright:
	@echo "â›” Stopping Playwright MCP server..."
	@if lsof -i :8931 >/dev/null 2>&1; then \
		lsof -ti tcp:8931 | xargs kill -9 2>/dev/null; \
		echo "   âœ… Playwright MCP server stopped"; \
	else \
		echo "   â„¹ï¸  Playwright MCP server was not running"; \
	fi

status:
	@./list_workspaces.sh
	@echo ""
	@echo "ğŸ­ Playwright MCP Server Status:"
	@if lsof -i :8931 >/dev/null 2>&1; then \
		echo "   âœ… Running on port 8931"; \
		echo "   ğŸ“Š Process: $$(lsof -ti tcp:8931 | head -1)"; \
	else \
		echo "   âŒ Not running"; \
		echo "   ğŸ’¡ Start with: make playwright"; \
	fi

help:
	@echo "ğŸš€ Optimum Codegen"
	@echo "================="
	@echo ""
	@echo "âš¡ Commands:"
	@echo "  make new <name>                  ğŸ¨ Create new feature workspace"
	@echo "  make rm <name>                   ğŸ—‘ï¸  Remove feature workspace"
	@echo "  make resume <name>               ğŸ”„ Resume feature workspace"
	@echo "  make ls                          ğŸ“‹ List all feature workspaces"
	@echo "  make playwright                  ğŸ­ Start playwright MCP server on port 8931 (background)"
	@echo "  make kill-playwright             â›” Stop playwright MCP server"
	@echo "  make status                      ğŸ“Š List workspaces and check playwright MCP server status"
	@echo ""
	@echo "ğŸ“‹ Recommended Workflow:"
	@echo "  1. (Optional) Ask Cursor to create a plan in plans/<name>.md"
	@echo "  2. Run: make new <name> (automatically starts Playwright and includes the plan if it exists)"
	@echo ""
	@echo "ğŸ“ Examples:"
	@echo "  make new dashboard-redesign"
	@echo "  make rm dashboard-redesign"
	@echo "  make resume dashboard-redesign"
	@echo "  make ls"
	@echo "  make status"
	@echo "  make playwright"
	@echo "  make kill-playwright"

# Default target shows help
.DEFAULT_GOAL := help

# Prevent make from treating arguments as targets
%:
	@:
